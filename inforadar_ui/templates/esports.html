{% extends "base.html" %}

{% block content %}
  <div id="table-loader" class="table-loader">
    <div class="mini-ring"></div>
    <span>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∏–±–µ—Ä—Å–ø–æ—Ä—Ç–∞...</span>
  </div>

  <div class="live-stats-panel">
    <h2 class="page-title">üéÆ Esports –ú–∞—Ç—á–∏</h2>
    <div class="live-filters">
      <label for="game-filter">–ò–≥—Ä–∞:</label>
      <select id="game-filter">
        <option value="all" selected>–í—Å–µ</option>
        <option value="CS2">Counter-Strike 2 üî´</option>
        <option value="Dota 2">Dota 2 ‚öîÔ∏è</option>
        <option value="Valorant">Valorant üéØ</option>
      </select>
    </div>
    <div class="live-stats">
      <span id="es-count">–ú–∞—Ç—á–µ–π: 0</span>
      <span id="last-update">–û–±–Ω–æ–≤–ª–µ–Ω–æ: --:--:--</span>
    </div>
  </div>

  <table id="esports-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>–ò–≥—Ä–∞/–õ–∏–≥–∞</th>
        <th>–¢—É—Ä–Ω–∏—Ä</th>
        <th>–ö–æ–º–∞–Ω–¥–∞ 1</th>
        <th>–ö–æ–º–∞–Ω–¥–∞ 2</th>
        <th>–°—á—ë—Ç</th>
        <th>–ù–∞—á–∞–ª–æ</th>
      </tr>
    </thead>
    <tbody id="esports-body"></tbody>
  </table>

  <p id="no-esports" style="display:none;text-align:center;color:#a24c00;font-weight:600;">
    –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—Ç—á–µ–π –∫–∏–±–µ—Ä—Å–ø–æ—Ä—Ç–∞.
  </p>

  <script>
    const bodyEl = document.getElementById('esports-body');
    const loader = document.getElementById('table-loader');
    const countEl = document.getElementById('es-count');
    const noEs = document.getElementById('no-esports');
    const lastUpd = document.getElementById('last-update');
    const gameFilter = document.getElementById('game-filter');

    let previous = {};

    // –ø—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞: –ø–æ league –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–≥—Ä—É
    function detectGame(m) {
      const L = (m.league || '').toLowerCase();
      if (L.includes('cs') || L.includes('counter')) return 'CS2';
      if (L.includes('dota')) return 'Dota 2';
      if (L.includes('valorant')) return 'Valorant';
      return m.league || 'Esports';
    }

    async function loadEsports() {
      loader.style.display = 'flex';
      try {
        const res = await fetch('/api/matches');
        const data = await res.json();
        loader.style.display = 'none';
        bodyEl.innerHTML = '';

        // –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –∫–∏–±–µ—Ä—Å–ø–æ—Ä—Ç (–ø–æ –ø–æ–ª—é sport)
        let matches = (data || []).filter(m => (m.sport || '').toLowerCase().includes('esport'));

        const selected = gameFilter.value;
        if (selected !== 'all') {
          matches = matches.filter(m => detectGame(m) === selected);
        }

        if (!matches.length) {
          noEs.style.display = 'block';
          countEl.textContent = '–ú–∞—Ç—á–µ–π: 0';
          return;
        }
        noEs.style.display = 'none';

        matches.forEach(m => {
          const id = m.id;
          const game = detectGame(m);
          const score = `${m.score_home ?? 0}-${m.score_away ?? 0}`;
          const prev = previous[id]?.score;

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${id}</td>
            <td>${game}</td>
            <td>${m.league ?? ''}</td>
            <td>${m.home_team ?? ''}</td>
            <td>${m.away_team ?? ''}</td>
            <td class="live-score">${score}</td>
            <td>${new Date(m.start_time).toLocaleString('ru-RU')}</td>
          `;

          if (prev && prev !== score) {
            row.classList.add('goal-flash');
            setTimeout(() => row.classList.remove('goal-flash'), 1500);
          }

          bodyEl.appendChild(row);
          previous[id] = { score };
        });

        updateStats(matches.length);
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Esports:', e);
        loader.style.display = 'none';
      }
    }

    function updateStats(count) {
      countEl.textContent = `–ú–∞—Ç—á–µ–π: ${count}`;
      lastUpd.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–æ: ' + new Date().toLocaleTimeString('ru-RU', { hour12: false });
      countEl.classList.add('count-flash');
      setTimeout(() => countEl.classList.remove('count-flash'), 800);
    }

    gameFilter.addEventListener('change', loadEsports);
    loadEsports();
    setInterval(loadEsports, 10000);
  </script>
{% endblock %}
