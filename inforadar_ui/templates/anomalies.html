<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OddlyOdds Anomalies</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="oo-body">
  <!-- Верхняя панель -->
  <header class="oo-header">
    <div class="oo-header-left">
      <a href="/" class="oo-logo">OddlyOdds</a>
      <span class="oo-header-section">Anomalies</span>
    </div>
    <div class="oo-header-right">
      <span class="oo-live-pill">LIVE</span>
    </div>
  </header>

  <main class="oo-main">
    <!-- Заголовок + период -->
    <section class="oo-anom-top">
      <div class="oo-anom-title">
        Лента аномалий
        <span id="period-label" class="oo-anom-period-label">(последние 20000 минут)</span>
      </div>

      <div class="oo-anom-top-right">
        <label class="oo-updated-label">
          Обновлено в <span id="last-updated">--:--:--</span>
        </label>

        <select id="period-select" class="oo-select">
          <option value="30">30 минут</option>
          <option value="60">1 час</option>
          <option value="180">3 часа</option>
          <option value="1440">24 часа</option>
          <option value="20000" selected>Все (20000 мин)</option>
        </select>
      </div>
    </section>

    <!-- Фильтры -->
    <section class="oo-anom-filters">
      <div class="oo-filter-group">
        <label for="filter-bookmaker">Букмекер</label>
        <select id="filter-bookmaker" class="oo-select">
          <option value="all">Все БК</option>
        </select>
      </div>

      <div class="oo-filter-group">
        <label for="filter-type">Тип</label>
        <select id="filter-type" class="oo-select">
          <option value="all">Все типы</option>
          <option value="Изменение коэффициента">Изменение коэффициента</option>
          <option value="Порезка лимита">Порезка лимита</option>
          <option value="Порезка коэффициентов">Порезка коэффициентов</option>
          <option value="Блокировка ставки">Блокировка ставки</option>
          <option value="Матч снят">Матч снят</option>
        </select>
      </div>

      <div class="oo-filter-group">
        <label for="filter-league">Лига</label>
        <select id="filter-league" class="oo-select">
          <option value="all">Все лиги</option>
        </select>
      </div>

      <div class="oo-filter-group oo-filter-wide">
        <label for="filter-search">Поиск по матчу</label>
        <input id="filter-search" type="text" class="oo-input"
               placeholder="Team A – Team B">
      </div>

      <div class="oo-filter-group oo-filter-small">
        <label>&nbsp;</label>
        <button id="filter-reset" class="oo-btn-secondary">Сбросить</button>
      </div>
    </section>

    <!-- Таблица аномалий -->
    <section class="oo-anom-table-wrapper">
      <div id="empty-state" class="oo-empty-state" style="display:none;">
        За выбранные условия аномалий не найдено.
      </div>

      <div class="oo-anom-table-scroll">
        <table class="oo-anom-table">
          <thead>
            <tr>
              <th class="col-time">Время</th>
              <th class="col-match">Матч</th>
              <th class="col-league">Лига</th>
              <th class="col-type">Тип</th>
              <th class="col-details">Детали</th>
              <th class="col-bookmaker">БК</th>
            </tr>
          </thead>
          <tbody id="anomalies-tbody">
          </tbody>
        </table>
      </div>

      <div class="oo-anom-footer-info">
        Показано: <span id="shown-count">0</span> аномалий
      </div>
    </section>
  </main>

  <script>
    // ====== Конфиг ======
    let currentMinutes = 20000;  // стартуем с "все"
    const FETCH_URL_BASE = '/api/anomalies?minutes=';

    // ====== DOM ======
    const tbodyEl = document.getElementById('anomalies-tbody');
    const emptyStateEl = document.getElementById('empty-state');
    const lastUpdatedEl = document.getElementById('last-updated');
    const periodLabelEl = document.getElementById('period-label');
    const shownCountEl = document.getElementById('shown-count');

    const periodSelectEl = document.getElementById('period-select');
    const filterBookmakerEl = document.getElementById('filter-bookmaker');
    const filterTypeEl = document.getElementById('filter-type');
    const filterLeagueEl = document.getElementById('filter-league');
    const filterSearchEl = document.getElementById('filter-search');
    const filterResetBtn = document.getElementById('filter-reset');

    // ====== Состояние ======
    let anomaliesRaw = [];

    const filters = {
      bookmaker: 'all',
      type: 'all',
      league: 'all',
      search: ''
    };

    function parseTime(str) {
      // "2025-11-15 23:08:26" → Date
      if (!str) return new Date(0);
      return new Date(str.replace(' ', 'T'));
    }

    // ====== Рендер фильтров ======
    function updateFilterOptions() {
      const bookies = new Set();
      const leagues = new Set();

      anomaliesRaw.forEach(a => {
        if (a.bookmaker) bookies.add(a.bookmaker);
        if (a.league) leagues.add(a.league);
      });

      const prevBookie = filters.bookmaker;
      const prevLeague = filters.league;

      filterBookmakerEl.innerHTML = '<option value="all">Все БК</option>';
      bookies.forEach(b => {
        const opt = document.createElement('option');
        opt.value = b;
        opt.textContent = b;
        filterBookmakerEl.appendChild(opt);
      });
      if ([...bookies].includes(prevBookie)) {
        filterBookmakerEl.value = prevBookie;
      } else {
        filters.bookmaker = 'all';
      }

      filterLeagueEl.innerHTML = '<option value="all">Все лиги</option>';
      leagues.forEach(l => {
        const opt = document.createElement('option');
        opt.value = l;
        opt.textContent = l;
        filterLeagueEl.appendChild(opt);
      });
      if ([...leagues].includes(prevLeague)) {
        filterLeagueEl.value = prevLeague;
      } else {
        filters.league = 'all';
      }
    }

    // ====== Рендер таблицы ======
    function renderTable() {
      tbodyEl.innerHTML = '';

      let list = anomaliesRaw.slice();

      // сортировка по времени (последние сверху)
      list.sort((a, b) => parseTime(b.time) - parseTime(a.time));

      // фильтрация
      list = list.filter(a => {
        if (filters.bookmaker !== 'all' && a.bookmaker !== filters.bookmaker) return false;
        if (filters.type !== 'all' && a.type_label !== filters.type) return false;
        if (filters.league !== 'all' && a.league !== filters.league) return false;

        if (filters.search) {
          const q = filters.search.toLowerCase();
          const match = (a.match || '').toLowerCase();
          if (!match.includes(q)) return false;
        }

        return true;
      });

      shownCountEl.textContent = list.length.toString();

      if (list.length === 0) {
        emptyStateEl.style.display = 'block';
        return;
      } else {
        emptyStateEl.style.display = 'none';
      }

      list.forEach(a => {
        const tr = document.createElement('tr');
        tr.className = 'oo-anom-row';

        const baseColor = a.badge_color || '#1f2937';
        tr.style.backgroundColor = baseColor;

        // Время
        const tdTime = document.createElement('td');
        tdTime.className = 'col-time';
        tdTime.textContent = a.time || '';
        tr.appendChild(tdTime);

        // Матч
        const tdMatch = document.createElement('td');
        tdMatch.className = 'col-match';
        tdMatch.textContent = a.match || '—';
        tr.appendChild(tdMatch);

        // Лига
        const tdLeague = document.createElement('td');
        tdLeague.className = 'col-league';
        tdLeague.textContent = a.league || '—';
        tr.appendChild(tdLeague);

        // Тип
        const tdType = document.createElement('td');
        tdType.className = 'col-type';
        tdType.textContent = a.type_label || '—';
        tr.appendChild(tdType);

        // Детали
        const tdDetails = document.createElement('td');
        tdDetails.className = 'col-details';
        tdDetails.textContent = a.details || '';
        tr.appendChild(tdDetails);

        // БК
        const tdBook = document.createElement('td');
        tdBook.className = 'col-bookmaker';
        tdBook.textContent = (a.bookmaker || '').toUpperCase();
        tr.appendChild(tdBook);

        tbodyEl.appendChild(tr);
      });
    }

    // ====== Загрузка данных ======
    async function fetchAnomalies() {
      try {
        const resp = await fetch(FETCH_URL_BASE + currentMinutes);
        if (!resp.ok) {
          console.error('Failed to fetch anomalies', resp.status);
          return;
        }
        const data = await resp.json();
        anomaliesRaw = Array.isArray(data) ? data : [];

        updateFilterOptions();
        renderTable();

        const now = new Date();
        const hh = String(now.getHours()).padStart(2, '0');
        const mm = String(now.getMinutes()).padStart(2, '0');
        const ss = String(now.getSeconds()).padStart(2, '0');
        lastUpdatedEl.textContent = `${hh}:${mm}:${ss}`;
      } catch (e) {
        console.error('Error fetching anomalies', e);
      }
    }

    // ====== Обработчики ======
    periodSelectEl.addEventListener('change', () => {
      currentMinutes = parseInt(periodSelectEl.value, 10) || 30;
      periodLabelEl.textContent = `(последние ${currentMinutes} минут)`;
      fetchAnomalies();
    });

    filterBookmakerEl.addEventListener('change', () => {
      filters.bookmaker = filterBookmakerEl.value;
      renderTable();
    });

    filterTypeEl.addEventListener('change', () => {
      filters.type = filterTypeEl.value;
      renderTable();
    });

    filterLeagueEl.addEventListener('change', () => {
      filters.league = filterLeagueEl.value;
      renderTable();
    });

    filterSearchEl.addEventListener('input', () => {
      filters.search = filterSearchEl.value.trim();
      renderTable();
    });

    filterResetBtn.addEventListener('click', () => {
      filters.bookmaker = 'all';
      filters.type = 'all';
      filters.league = 'all';
      filters.search = '';

      filterBookmakerEl.value = 'all';
      filterTypeEl.value = 'all';
      filterLeagueEl.value = 'all';
      filterSearchEl.value = '';

      renderTable();
    });

    document.addEventListener('DOMContentLoaded', () => {
      fetchAnomalies();
      setInterval(fetchAnomalies, 10000);
    });
  </script>
</body>
</html>
